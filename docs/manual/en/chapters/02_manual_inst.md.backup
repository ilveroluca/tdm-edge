## 2. INSTALLATION

The installation requirements are:

* A PC with a Linux distribution and a SD/microSD card reader;
* ‘*root*’ privileges;
* SD/microSD adapter;
* WiFi conntection;

The current Edge Gateway version is composed by:

* A Raspberry Pi 3;
* power supply 220V/5V able to deliver at least 2.5A;
* class 10 microSD (min 8GB, suggested 16GB);

The described installation procedure allow to:

* Install the customized operating system on the Edge Gateway;
* configure the local WiFi;
* install EDGE microservices;
* configure the TDM software and start services 

Moreover an example of connection between the Edge system and a temperature/humidity sensor ( HTD21D) is shown.

### 2.1 INSTALLATION OF THE OPERATING SYSTEM TO THE EDGE GATEWAY

***Note: The power supply of the Raspberry Pi 3 must be able to deliver al least 2.5A to avoid malfunctioning and filesystem corruption.***

***Note: The procedure here described is partially based on the installation of Archh Linux to the ARMv7 architecture (available at: <https://archlinuxarm.org/platforms/armv8/broadcom/raspberry-pi-3>).***

To complete successfully the installation, the commands have to be typed on a Linux console as ‘***root***’ user or with administrator privileges. A ‘***sudo***’ shell can be used as well.
To start a ‘***sudo***’ shell type:

```bash
sudo -s
```

and insert the user password.



### **WARNING: the following instructions will erase all filesystems on microSD. Every file will be deleted. Pay close attention to the names of the devices to which the commands are directed.**

Replace ***sdX*** with the name of the SD device as shown on the display.
The command *fdisk -l* can be used before and after the insertion of the SD card to find out the right device ID.

1. Insert the microSD to the SD card reader (use the adapter if needed);
2. before partitioning the microSD check if the operating system mounted some existing partition on the SD. To do it, take a look at the *mount* command output. If one or more partition with  **sdX** suffix is present (for instance ***sdX1***) unmount by typing:


  ```bash
umount /dev/sdX{partition_number}
  ``` 
  
3. Create partitions on the microSD by using the ***fdisk*** command:

  ```bash
fdisk /dev/sdX
  ```
  
4. At fdisk prompt, remove old partitions and create a new one:

  **a.** Type **o + ENTER**. All the partitions will be erased
  
  **b.** Type **p + ENTER** to list the partion. The output should be empty.
  
  **c.** Type **n + ENTER**, then **p** to select primary partition, **1** to specify the first partition on the device. Accept the default first sector pressing **ENTER** and type **+100M** to specify the last sector. If required, press **y** to remove the *vfat* or *ext4* signature from the first partition.
  
  **d.** Type **t + ENTER**, then c to set the first partition type to W95 FAT32 (LBA).
  
  **e.** Type **n + ENTER**, then **p** to select primary partition, **2** to specify the second partition on the device. Press twice **ENTER** to accept the default values of first and last sector.If required, press **y** to remove the *vfat* or *ext4* signature from the first partition.
  
  **f.** Type **w + ENTER** to write out the partition table and quit fdisk.
5. Creare e montare il filesystem FAT:

  ```bash
cd /tmp/
mkfs.vfat /dev/sdX1
mkdir boot
mount /dev/sdX1 boot
  ```

6. Creare e montare il filesystem ext4:

  ```bash
mkfs.ext4 /dev/sdX2
mkdir root
mount /dev/sdX2 root
  ```
  
6. Scaricare ed estrarre il filesystem di root (per preservare i permessi dei file, eseguire il comando come utente
*root* e non utilizzando il comando *sudo*):

   ```bash
wget --content-disposition \    
    https://space.crs4.it/s/ywvVDh3tuOBWCZ2/download
tar -xpf TDM-Arm-image-latest.tar.gz -C root
sync
   ```
Il comando ‘*tar*’ potrebbe mostrare messaggi di errore quali:

  * tar: Ignoring unknown extended header keyword 'SCHILY.fflags'
  * tar: Ignoring unknown extended header keyword 'LIBARCHIVE.xattr.security.capability'

  Su alcuni sistemi sono previsti e possono essere ignorati.

7. Spostare i file di avvio nella prima partizione:

  ```bash
mv root/boot/* boot
  ```

8. Smontare le due partizioni:

  ```bash
umount boot root
  ```

  Ora è possibile uscire dalla shell sudo, se in uso, premendo **CTRL+D** o digitando

  ```bash
exit
  ```

### 2.2 PRIMO ACCESSO ALL’EDGE GATEWAY E CONFIGURAZIONE WIFI
Appena avviato l’Edge Gateway si presenta come un Access Point con una sua rete WiFi privata. Attraverso questa è
possibile accedere al dispositivo.

1. Inserire la scheda microSD nella Raspberry Pi e applicare l'alimentazione 5V;
2. attendere alcuni secondi che si avvii il sistema operativo;
3. dal PC, cercare una rete WIFI che abbia un nome simile a ‘TDM_XXXXXXXX’ e collegarsi utilizzando la
password ‘***tdmedgegateway***’;

  ### **ATTENZIONE**: lasciare attiva la rete WiFi locale dell’Edge **senza cambiare la password di default potrebbe permettere l’accesso all’Edge a chiunque conosca tale password**. Si consiglia di modificarla al primo accesso o disabilitare la rete WiFi locale dell’Edge con i commandi mostrati nella sezione '***Cambio password utente e passphrase WiFi***'.

4. Utilizzando un terminale SSH collegarsi all'indirizzo IP ‘***192.168.2.1***’:

  * Effettuare il login come utente predefinito ‘*alarm*’ con password ‘*alarm*’:
  
  ```bash
ssh alarm@192.168.2.1  
  ```
  
  Appena entrati sull’Edge viene richiesto di cambiare obbligatoriamente la password di accesso:

  * digitare la password corrente ‘*alarm*’
  * digitare la nuova password, contenente almeno 8 caratteri
  * ri-digitare la nuova password per conferma

	Il collegamento SSH a questo punto viene terminato e si può procedere a ricollegarsi usando la nuova
password.

#### Configurazione WiFi domestica sull’Edge Gateway

**ATTENZIONE**: per sicurezza, l’utente ‘*root*’ è disabilitato, Le operazioni di amministrazione sono possibili solo attraverso l’uso del comando ‘***sudo***’.

5. Ottenere i privilegi di *amministratore* inserendo la password quando richiesto dopo aver digitato il comando:

  ```bash
sudo -s
  ```

6. Configurare l’Edge Gateway per collegarsi alla rete WIFI casalinga; sostituire <ESSID> con il nome della rete WIFI domestica e dopo aver digitato il seguente comando:

  ```bash
wpa_passphrase "<ESSID>" > /etc/wpa_supplicant/wpa_supplicant-wlan0.conf
  ```
  
7. il precedente comando non fornisce un *prompt*, cioè non stampa nessun messaggio di testo ma resta in
attesa di input da parte dell’utente; inserire la password della rete WiFi domestica e premere **ENTER**;

8. Riavviare l’interfaccia di rete wireless per rendere effettive le modifiche:

  ```bash
systemctl restart wpa_supplicant@wlan0
  ```

9. Se tutto è andato correttamente, l’indirizzo IP assegnato dal router wireless casalingo può essere ricavato col comando:

  ```bash
ifconfig wlan0
  ```
  
  Annotare l’IP in modo da poterlo usare per accedervi successivamente e per la configurazione delle stazioni di rilevamento.

10. Ora è possibile uscire dalla shell sudo, se in uso, premendo **CTRL+D** o digitando

  ```bash
exit
  ```
  
#### Cambio password utente e passphrase WiFi
Per modificare successivamente la password dell’utente ‘alarm’ digitare il comando:

  ```bash
passwd
  ```

e:

* digitare la password corrente
* digitare la nuova password, contenente almeno 8 caratteri
* ri-digitare la nuova password per conferma.

Per modificare la passphrase per la rete wireless creata dall’Edge Gateway, digitare:

  ```bash
sudo hostap_chpsk
  ```

* digitare la nuova passphrase, contenente minimo 8 caratteri e massimo 63
* ri-digitare la nuova passphrase per conferma.

Se non necessaria, è possibile disabilitare la rete wireless creata dall’Edge Gateway coi comandi:

  ```bash
sudo systemctl disable start_ap
sudo systemctl stop start_ap
  ```
  
### 2.3 INSTALLAZIONE SOFTWARE TDM
Per procedere alle operazioni che seguono occorre per prima cosa eseguire il login ssh all’indirizzo annotato in precedenza usando l’utente alarm. Ottenuto l’accesso passare all’utente root digitando il comando:

  ```bash
sudo -s
  ```

e inserendo la password dell’utente corrente.

#### 2.3.1 Versione di sviluppo

  ```bash
cd /opt
git clone https://github.com/tdm-project/tdm-edge.git
cd tdm-edge
git checkout develop
  ```
